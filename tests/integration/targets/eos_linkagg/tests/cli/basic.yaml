---
- debug: msg="START cli/basic.yaml"

- name: setup - remove config used in test(part1)
  become: true
  arista.eos.eos_config:
    lines:
      - no interface port-channel 20
      - no interface port-channel 100

- name: setup - remove config used in test(part2)
  loop:
    - interface Ethernet1
    - interface Ethernet2
  become: true
  arista.eos.eos_config:
    lines:
      - no channel-group 20
    parents: '{{ item }}'

- name: create linkagg
  become: true
  register: result
  arista.eos.eos_linkagg: &id001
    group: 20
    state: present

- assert:
    that:
      - result.changed == true
      - "'interface port-channel 20' in result.commands"

- name: create linkagg(Idempotence)
  become: true
  register: result
  arista.eos.eos_linkagg: *id001

- assert:
    that:
      - result.changed == false

- name: set link aggregation group to members
  become: true
  register: result
  arista.eos.eos_linkagg: &id002
    group: 20
    mode: active
    members:
      - Ethernet1
      - Ethernet2

- assert:
    that:
      - result.changed == true
      - "'interface Ethernet1' in result.commands"
      - "'channel-group 20 mode active' in result.commands"
      - "'interface Ethernet2' in result.commands"
      - "'channel-group 20 mode active' in result.commands"

- name: set link aggregation group to members(Idempotence)
  become: true
  register: result
  arista.eos.eos_linkagg: *id002

- assert:
    that:
      - result.changed == false

- name: remove link aggregation group from member
  become: true
  register: result
  arista.eos.eos_linkagg: &id003
    group: 20
    mode: active
    members:
      - Ethernet2

- assert:
    that:
      - result.changed == true
      - "'interface Ethernet1' in result.commands"
      - "'no channel-group 20' in result.commands"

- name: remove link aggregation group from member(Idempotence)
  become: true
  register: result
  arista.eos.eos_linkagg: *id003

- assert:
    that:
      - result.changed == false

- name: remove linkagg
  become: true
  register: result
  arista.eos.eos_linkagg: &id004
    group: 20
    state: absent

- assert:
    that:
      - result.changed == true
      - "'no interface port-channel 20' in result.commands"

- name: remove linkagg(Idempotence)
  become: true
  register: result
  arista.eos.eos_linkagg: *id004

- assert:
    that:
      - result.changed == false

- name: create aggregate of linkagg definitions
  become: true
  register: result
  arista.eos.eos_linkagg: &id005
    aggregate:

      - group: 20
        min_links: 3

      - group: 100
        min_links: 4

- assert:
    that:
      - result.changed == true
      - "'interface port-channel 20' in result.commands"
      - "'port-channel min-links 3' in result.commands"
      - "'interface port-channel 100' in result.commands"
      - "'port-channel min-links 4' in result.commands"

- name: create aggregate of linkagg definitions(Idempotence)
  become: true
  register: result
  arista.eos.eos_linkagg: *id005

- assert:
    that:
      - result.changed == false

- name: remove aggregate of linkagg definitions
  become: true
  register: result
  arista.eos.eos_linkagg: &id006
    aggregate:

      - group: 20
        min_links: 3

      - group: 100
        min_links: 4
    state: absent

- assert:
    that:
      - result.changed == true
      - "'no interface port-channel 20' in result.commands"
      - "'no interface port-channel 100' in result.commands"

- name: remove aggregate of linkagg definitions(Idempotence)
  become: true
  register: result
  arista.eos.eos_linkagg: *id006

- assert:
    that:
      - result.changed == false

- name: teardown(part1)
  become: true
  arista.eos.eos_config:
    lines:
      - no interface port-channel 20
      - no interface port-channel 100

- name: teardown(part2)
  become: true
  loop:
    - interface Ethernet1
    - interface Ethernet2
  arista.eos.eos_config:
    lines:
      - no channel-group 20
    parents: '{{ item }}'

- debug: msg="END cli/basic.yaml"
