---
name: Integration tests ðŸ’»
on:
  pull_request_target:
    branches: [main]
    types:
      - labeled
      - opened
      - reopened
      - synchronize
    paths:
      - "plugins/**"
      - "tests/integration/**"
  workflow_dispatch:
jobs:
  lab-create:
    uses: ansible/ansible-content-actions/.github/workflows/cml_lab_create.yaml@main
    with:
      topology_path: tests/integration/labs/multi.yaml
    secrets:
      virl_host: ${{ secrets.VIRL_HOST }}
      virl_username: ${{ secrets.VIRL_USERNAME }}
      virl_password: ${{ secrets.VIRL_PASSWORD }}

  pre-configure-lab:
    needs: lab-create
    name: Pre-Configure Lab Devices
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Ansible and dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install ansible
          ansible-galaxy collection install arista.eos

      - name: Fetch pre-config playbook from PR or branch
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const ref = context.eventName === 'pull_request_target'
              ? context.payload.pull_request.head.sha
              : context.ref;

            console.log(`Fetching pre-config.yml from ref: ${ref}`);

            const response = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'tests/integration/pre-config.yml',
              ref: ref
            });

            fs.writeFileSync('pre-config.yml', Buffer.from(response.data.content, 'base64').toString());
            console.log('Successfully fetched and wrote pre-config.yml');
      
      - name: Verify playbook exists
        run: |
          ls -l pre-config.yml
          cat pre-config.yml

      - name: Create Temporary Inventory
        id: inventory
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          LAB_NODES_JSON='${{ needs.lab-create.outputs.lab_nodes_json }}'
          INVENTORY_FILE=$(mktemp)
          # Get the IP and calculate the SSH port
          DEVICE_IP=$(echo $LAB_NODES_JSON | jq -r '.nodes."stable-2.16"')
          LAST_OCTET=$(echo $DEVICE_IP | cut -d . -f 4)
          SSH_PORT=$((LAST_OCTET + 2000))
          
          # Build the inventory file
          echo "[all:vars]" > $INVENTORY_FILE
          echo "ansible_network_os=arista.eos.eos" >> $INVENTORY_FILE
          echo "ansible_user=ansible" >> $INVENTORY_FILE
          echo "ansible_ssh_pass=admin" >> $INVENTORY_FILE
          echo "ansible_connection=ansible.netcommon.network_cli" >> $INVENTORY_FILE
          echo "ansible_port=$SSH_PORT" >> $INVENTORY_FILE
          echo "ansible_become=true" >> $INVENTORY_FILE
          echo "ansible_become_method=enable" >> $INVENTORY_FILE
          echo "" >> $INVENTORY_FILE
          echo "[eos]" >> $INVENTORY_FILE
          echo "$DEVICE_IP" >> $INVENTORY_FILE
          
          # Set output and log
          echo "inventory_path=$INVENTORY_FILE" >> $GITHUB_OUTPUT
          echo "Created inventory file at $INVENTORY_FILE with content:"
          cat $INVENTORY_FILE

      - name: Apply Pre-Configuration to vEOS Node
        run: |
          ansible-playbook pre-config.yml -i ${{ steps.inventory.outputs.inventory_path }} -v

  integration-tests:
    needs: [lab-create, pre-configure-lab]
    strategy:
      fail-fast: true
      matrix:
        ansible_version: ["stable-2.16"]
    uses: ansible/ansible-content-actions/.github/workflows/cml_network_integration.yaml@main
    with:
      ansible_version: ${{ matrix.ansible_version }}
      lab_nodes: ${{ needs.lab-create.outputs.lab_nodes_json }}

  lab-destroy:
    if: ${{ always() }}
    needs: [integration-tests, pre-configure-lab]
    uses: ansible/ansible-content-actions/.github/workflows/cml_lab_destroy.yaml@main
    secrets:
      virl_host: ${{ secrets.VIRL_HOST }}
      virl_username: ${{ secrets.VIRL_USERNAME }}
      virl_password: ${{ secrets.VIRL_PASSWORD }}
